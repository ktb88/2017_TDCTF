#!/usr/bin/python
#-*- coding: utf-8 -*-

import sys
import datetime
import random

FLAG = "TDCTF{that_little_trouble_breaks_whole_systems}"

p = 162055972267038837888685407891727003074319810755530453448527026345900381108457898060986726676133790622870948881516367635513581212425149794674813142558920559569160015211344302924098022547652453266970794497986240666862128487448491806369133896567341368622548119096458986055553290312093565422826453921171594287967
q = 110969449419289780819908418568361163584600243257269712255942776835831282333161115978642905676200400268173078866009745492943982608182462266312488199430671353866915568900386227574595865140687919288762779489758767190915043821067914090668391976459330276842287738576766152960305541289302380323043055550890836653311
n = p*q
e = 65537
phi = 17983262017580993794511614578913774435109468549792929446910442458748420026446623455073185187549370273861728892253442437960741766393448920041559395672578684852117883141351949543112936902274694086644461204323835923405683019409313814352584827753160235157290547103087359843670683990045096654478339118242860523489192595643426731310183687129683364003265171904798325618920002303230662507663449294907164321848665852811771071387567497791776673295093406824120159966022668787700766953580428639370236049025093986241553764645694509591662009854321660616292488613056654967019143959311922290643704816376067021534664121028743847067460
d = 17449556711811809472215429365126336937569332194309046330895964979122168032131371267452187198782970756296673081101986839721065816386044581279015595611801329433997290457678153948847794123769051777742261270814370112168915186387492318572860740749179328839013388946389541589921817237513889657011864156236934653855451661537098016349195126904661862515764206658375194512387823465630777884055328555804147177243394706990038390095338393877880620232564504428940128668680494278765692236631011764878344306721451649801987991536826605641896494051543754549510535054724793668655590012673203874248355534781678350144687135274118112252833
# dp = mod(d, p-1)
dp = 58692960583036053773072262107176589483376642630777588889546935278488356897483202898753085194389606698879485521944436000984945353893576995077610582598814996138571831500625118241701491725148826323219231551706691006128438619071324618398427791460128091393026872680677334833981001554051190455410054019453575263121
# dq = mod(d, q-1)
dq = 92264298012681388480962047817110941967512508279119071987218241753275959753024233786658710809102641418019608273324549978035577037701792405684841875383024582635888572094878397554659637937593797733260354523352537104734130915513231286151649889333794753881567036560232962674627293663946880446200102186063470852173
np = n/p
nq = n/q
# mod(q^-1, p)
sp =  138727484785596086760916753054923915703729641285093885293558255518292000231299296509417170483744607165761404823764802819623753691072684411133964794121420273009234376690992605227718639619455053962737114959256035811206373939953358421311018807895695685240377645110132735025577232108206309227541221094347122095507
#mod (p^-1, q)
sq = 15974415354064871540470402193440978498721397425027698889073531819396613424618774779519071036600813769517838535776619692782590919163606884114456944050256409255382151586520271866299739619471897427292194013773520367377951883951996273801690760494192449826242274360633991643354802515414601826165121017520871541483

# Translate a number to a string (byte array), for example 5678 = 0x162e = \x16\x2e
def num2str(n):
    d = ('%x' % n)
    if len(d) % 2 == 1:
        d = '0' + d
    return d.decode('hex')

# Translate byte array back to number \x16\x2e = 0x162e = 5678
def str2num(s):
    return int(s.encode('hex'),16)

def send_msg(msg):
	sys.stdout.write(msg)
	sys.stdout.flush()

def main():
	while True:
		send_msg("Welcome to commuting system.\n1. Get a token\n2. Check a token\n3. Admin Login\n4. Exit!\nChoice: ")

		inp = raw_input()
		if inp == '1':
			send_msg("\nPunch In(1) or Punch Out(!1):")
			action = raw_input()

			send_msg("Name: ")
			uname = raw_input()

			now = datetime.datetime.now()
			if(action == "1"):
				ticket = 'PI|name:%s|time:%s|' % ( uname, now.strftime('%Y-%m-%d %H:%M:%S'))
			else:
				ticket = 'PO|name:%s|time:%s|' % ( uname, now.strftime('%Y-%m-%d %H:%M:%S'))

			send_msg("Message : %s\n" % ticket)
			ticketp = pow(str2num(ticket),dp,p)
			if random.randrange(0,11) == 0:
				ticketp = ticketp + 1
			ticketq = pow(str2num(ticket),dq,q)
			ticket = pow(ticketp*np*sp + ticketq*nq*sq, 1, n)
			ticket = num2str(ticket)
			send_msg("Token:\n" + ticket.encode('hex') + "\n")
			send_msg("n :\n" + num2str(n).encode("hex") + "\n")
			send_msg("e :\n" + num2str(e).encode("hex") + "\n\n")
		elif inp == '2':
			send_msg("Input token (hexstream, ex: 8ee3a...): ")
			ticket = raw_input()
			try:
				ticket = int(ticket,16)
			except:
				ticket = 0
			ticket = pow(ticket,e,n)
			ticket = num2str(ticket)
			send_msg(ticket + "\n")    
		elif inp == '3':
			send_msg("[ADMIN ONLY] Input your (d): ")
			dd = raw_input()
			if d == int(dd) :
				send_msg("YOU ARE ADMIN\nHere is your message:" + FLAG + "\n")
			else:
				send_msg("You are not admin\n")
		elif inp == '4':
			send_msg("Bye~\n")
			break
		else:
			send_msg("Wrong menu\n")

if __name__ == "__main__":
	main()

